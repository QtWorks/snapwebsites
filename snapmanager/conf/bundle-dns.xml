<?xml version="1.0"?>
<!--
  see /usr/share/snapwebsites/xsd/bundles.xsd for details
  to verify your changes (change the == with two dashes):
    xmllint ==noout ==schema /usr/share/snapwebsites/xsd/bundles.xsd /etc/snapwebsites/services.d/bundle-tools.xml
-->
<bundle>
  <name>dns</name>
  <description>
    <p>This bundle installs the Domain Name Server (bind9) on your machine.</p>
  </description>
  <packages>bind9</packages>
  <postinst>
    # Fixed a few parameters which are considered unsafe by PCI
    # (these are really just ofuscation of the DNS)
    NAMED_CONF=/etc/bind/named.conf.options

    if test ! -f ${NAMED_CONF}.bak
    then
      cp ${NAMED_CONF} ${NAMED_CONF}.bak
    fi

    # 
    dns_options -e 'options.version = none'   ${NAMED_CONF}
    dns_options -e 'options.hostname = none'  ${NAMED_CONF}
    dns_options -e 'options.server-id = none' ${NAMED_CONF}

    dns_options -e 'acl[bogusnets]._ = 0.0.0.0/8;'      ${NAMED_CONF}
    dns_options -e 'acl[bogusnets]._ = 192.0.2.0/24;'   ${NAMED_CONF}
    dns_options -e 'acl[bogusnets]._ = 224.0.0.0/3;'    ${NAMED_CONF}

    # The following may be used by the private network
    #dns_options -e 'acl[bogusnets]._ = 10.0.0.0/8;'     ${NAMED_CONF}
    #dns_options -e 'acl[bogusnets]._ = 172.16.0.0/12;'  ${NAMED_CONF}
    #dns_options -e 'acl[bogusnets]._ = 192.168.0.0/16;' ${NAMED_CONF}

    dns_options -e 'options.blackhole._ = bogusnets;' ${NAMED_CONF}

    # Install the bind9 jail knowing that fail2ban may not be installed
    if test ! -d /etc/fail2ban/jail.d
    then
      mkdir -p /etc/fail2ban/jail.d
      chmod 775 /etc/fail2ban
      chmod 755 /etc/fail2ban/jail.d
    fi
    cp /usr/share/snapwebsites/fail2ban/snap-named-jail.conf /etc/fail2ban/jail.d/.
  </postinst>
  <!--
    Leave the zone files just in case the user wants to reuse them after
    removal.
  -->
  <prerm>
    # Remove locally generated files...
    #rm /etc/bind/*.zone*

    # Remove the jail we installed manually
    rm -f /etc/fail2ban/jail.d/snap-named-jail.conf
    rmdir --ignore-fail-on-non-empty /etc/fail2ban/jail.d
    rmdir --ignore-fail-on-non-empty /etc/fail2ban
  </prerm>
</bundle>
<!--
  vim: ts=2 sw=2 et
-->
